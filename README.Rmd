---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# rosmium

[![CRAN
status](https://www.r-pkg.org/badges/version/rosmium)](https://CRAN.R-project.org/package=rosmium)
[![B
status](https://github.com/dhersz/rosmium/workflows/check/badge.svg)](https://github.com/dhersz/rosmium/actions?query=workflow%3Acheck)
[![Codecov test
coverage](https://codecov.io/gh/dhersz/rosmium/branch/main/graph/badge.svg)](https://app.codecov.io/gh/dhersz/rosmium?branch=main)
[![Repo
status](https://www.repostatus.org/badges/latest/concept.svg)](https://www.repostatus.org/#concept)

**rosmium** allows one to use [Osmium Tool](https://osmcode.org/osmium-tool/)
from R. Osmium is a multipurpose command line tool that enables one to
manipulate and analyze OpenStreetMap (OSM) files through several different
commands. Currently, this package does not aim to offer functions that cover the
entirety of Osmium's API, instead making available functions that wrap only a
very limited set of Osmium's features. 

## Installation

Development version:

```r
# install.packages("remotes")
remotes::install_github("dhersz/rosmium")
```

Please note that **rosmium** requires Osmium to be installed and added to the
PATH environment variable of your local system. For instructions on how to
install Osmium, please check [its official
website](https://osmcode.org/osmium-tool/#download).

## Usage

The package currently includes only three entrypoints to Osmium's API. To
demonstrate them, we will use some sample data bundled with the package.

```{r}
library(rosmium)
library(ggplot2)

cur_pbf <- system.file("extdata/cur.osm.pbf", package = "rosmium")

cur_pbf_lines <- sf::st_read(cur_pbf, layer = "lines", quiet = TRUE)

ggplot(cur_pbf_lines) + geom_sf()
```

### `extract()`

`extract()` creates geographical extracts from OSM files. In its most basic
form, the function takes the path to the OSM file whose geographical extent
should be extracted from, the extent, either as a bounding box or as a
(multi)polygon, and the path to the file where the output should be written to.
Additionally, the function can also take the strategy to be used when creating
the extract, which defaults to `"complete_ways"`. Please check the function
documentation for details on the available strategies and their behavior.

```{r}
# buffering the pbf bounding box 4000 meters inward and using the result
# extent to extract the osm data inside it. transforming the crs because
# inward buffers only work with projected crs

bbox <- sf::st_bbox(cur_pbf_lines)
bbox_polygon <- sf::st_as_sf(sf::st_as_sfc(bbox))
smaller_bbox_poly <- sf::st_buffer(sf::st_transform(bbox_polygon, 5880), -4000)
smaller_bbox_poly <- sf::st_transform(smaller_bbox_poly, 4326)

output_path <- extract(
  cur_pbf,
  smaller_bbox_poly,
  tempfile(fileext = ".osm.pbf")
)

extracted_pbf_lines <- sf::st_read(output_path, layer = "lines", quiet = TRUE)

ggplot() +
  geom_sf(data = extracted_pbf_lines) +
  geom_sf(data = smaller_bbox_poly, color = "red", fill = NA)
```

### `tags_filter()`

`tags_filter()` filters OSM files, keeping objects matching at least one of the
specified expressions from the input. In its most basic form, the function takes
the path to the OSM file to which the filters should be applied, the filter
expressions that should be applied and the path to the file where the output
should be written to. Please check the function documentation for a description
of the filter expression format.

By default, not only the objects matching the expressions will be kept in the
output, but also the objects referenced by them. This behavior can be changed
with the `omit_referenced` parameter. The function also includes the
`invert_match` parameter, that inverts the sense of matching (excluding objects
that match the filters), and the `remove_tags` parameter, used to remove tags
from objects that are referenced by objects matching the filters, but which do
not match the filter themselves. Both arguments default to `FALSE`.

```{r}
# get all amenity nodes
output <- tags_filter(cur_pbf, "n/amenity", tempfile(fileext = ".osm.pbf"))
nodes <- sf::st_read(output, layer = "points", quiet = TRUE)
head(nodes$other_tags)

# get all objects (nodes, ways or relations) with an addr:* tag
output <- tags_filter(
  cur_pbf,
  "addr:*",
  tempfile(fileext = ".osm.pbf"),
  omit_referenced = TRUE
)
nodes <- sf::st_read(output, layer = "points", quiet = TRUE)
head(nodes$other_tags)
```

